---
title: "OCNMS eDNA Metadata Cleaning"
author: "Eleanor (Ella) Crotty"
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
output:
  pdf_document:
    toc: TRUE
urlcolor: blue
---

```{r Package Imports, message = F, warning = F}
# Warnings and startup messages suppressed
library(tidyverse)
library(patchwork)
library(scales)
library(ggrepel)
library(readxl)
library(here)
library(measurements)
library(sp)
```

```{r}
JV_Data <- read.csv(here("JV243.2_sampleData.csv"), header = T)

sample_Data <- read.csv(file = here("20240621_OCNMS_eDNA_sampleData_zjg.csv"), header=T,fileEncoding="UTF-8")
```

```{r}
sample_Data %>% 
  filter(., str_detect(Sample_Name,"OC")) %>% # Filter for only OCNMS samples
  mutate(., Combined_date = str_c(Collection_Date_UTC, " ",Collection_Time_UTC), # Several steps from Zack to fix datetime
         Combined_date_local = str_c(Collection_Date_local, " ",Collection_Time_local)) %>% 
  mutate(.,  Date_UTC = as.POSIXct(Combined_date, format="%m/%d/%y %H:%M", tz="UTC"),
         Date_local = as.POSIXct(Combined_date_local, format="%m/%d/%y %H:%M", tz="America/Los_Angeles")) %>%
  mutate(., Date_local_check= format(Date_UTC,tz="America/Los_Angeles"),
                  Date_UTC_check= format(Date_local,tz="GMT")) %>% 
   mutate(.,      Date_local_check= as.POSIXct(Date_local_check, format="%Y-%m-%d %H:%M:%S", tz="America/Los_Angeles"),
         Date_UTC_check= as.POSIXct(Date_UTC_check, format="%Y-%m-%d %H:%M:%S", tz="UTC")) %>% 
  mutate(.,Date_UTC = case_when(is.na(Date_UTC) ~ Date_UTC_check,
                                TRUE ~ Date_UTC),
           Date_local = case_when(is.na(Date_local) ~ Date_local_check,
                                TRUE ~ Date_local)) %>% 
  dplyr::select(-Date_UTC_check,-Date_local_check) -> time_cor_ocnms
```

```{r}
OCNMS_sample_metadata <- time_cor_ocnms %>% 
  mutate(., Lat_fix =str_remove(Lat, "' N")) %>% # Several steps from Zack to convert degrees/feet to decimal degrees
    mutate(., Lat_fix =str_replace(Lat_fix, "˚","")) %>% 
  mutate(., Lat_dec = measurements::conv_unit(Lat_fix,'deg_dec_min','dec_deg')) %>% 
  mutate(., Lon_fix =str_remove(Lon, "' W")) %>% 
    mutate(., Lon_fix =str_replace(Lon_fix, "˚","")) %>%
    mutate(., Lon_dec = measurements::conv_unit(Lon_fix,'deg_dec_min','dec_deg')) %>% 
  mutate(., Lat_dec=as.double(Lat_dec),
         Lon_dec=as.double(Lon_dec)) %>% 
    mutate(., Lon_dec = Lon_dec*-1) %>% 
  mutate(., Lat_dec = case_when(is.na(Lat_dec_sean) ~ Lat_dec,
                                TRUE ~Lat_dec_sean ),
         Lon_dec = case_when(is.na(Lat_dec_sean) ~ Lon_dec,
                                TRUE ~Lon_dec_sean )) %>% 
  left_join(., JV_Data, by=c("Sample_Name"="OwnerSampleId")) %>% # Attach metadata by E number
  select(-c(Lat, Lon, Lat_dec_sean, Lon_dec_sean, Lat_fix, Lon_fix, Combined_date, Combined_date_local, Collection_Date_UTC, Collection_Date_local, Collection_Time_UTC, Collection_Time_local)) # Delete all the nonsense generated by the coordinate fixing, and all the date and time columns except the final ones
```

```{r}
here::i_am("OCNMS.Rproj")
here()
write.csv(OCNMS_sample_metadata, here("OCNMS_eDNA_sampleData_Full2.csv")) # Save to Zack OCNMS outputs

here::i_am("PMEL-Hollings-eDNA-Hypoxia-2024.Rproj") # Set working directory to further up in the repo
here()
write.csv(OCNMS_sample_metadata, here("OCNMS_eDNA", "Data", "OCNMS_eDNA_sampleData_Full.csv")) # Also save to eDNA inputs

here::i_am("OCNMS.Rproj") # Reset to normal here so I can run other stuff in this script
```



