---
title: "Data Carpentry Tutorial"
author: "Ella Crotty"
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
output:
  pdf_document:
    toc: TRUE
---

```{r}
library(tidyverse)
library(lubridate)
```

[Tutorial used](https://datacarpentry.org/R-ecology-lesson/02-starting-with-data.html)

- Object names can't start with a number
- Styles can include “lower_snake”, “UPPER_SNAKE”, “lowerCamelCase”, “UpperCamelCase”
- [Tidyverse Style Guide](https://style.tidyverse.org/)
- R indices start at 1

# Filtering
```{r}
round(digits = 2, x = 3.14159)
round(3.14159, 2)
weight_g <- c(21, 34, 39, 54, 54, 55)
weight_g <- c(weight_g, 90) # add to the end of the vector
weight_g > 50    # will return logicals with TRUE for the indices that meet the condition
#> [1] FALSE FALSE FALSE  TRUE  TRUE
## so we can use this to select only the values above 50
weight_g[weight_g > 50]
weight_g[weight_g == 39 | weight_g == 54]
weight_g[weight_g %in% c(21,39, 54)]

heights <- c(63, 69, 60, 65, NA, 68, 61, 70, 61, 59, 64, 69, 63, 63, NA, 72, 65, 64, 70, 63, 65)
heights_no_na <- na.omit(heights)
heights_no_na
```

# Dataframes
```{r}
# download.file(url = "https://ndownloader.figshare.com/files/2292169",
              # destfile = "~/Dropbox/Coding/Summer2024/RTutorials/DataCarpentry/RawData/portal_data_joined.csv")
surveys <- read_csv("~/Dropbox/Coding/Summer2024/RTutorials/DataCarpentry/RawData/portal_data_joined.csv")
summary(surveys)
names(surveys)
rownames(surveys)[1:5]

year_fct <- factor(c(1990, 1983, 1977, 1998, 1990))
as.numeric(year_fct)               # Wrong! And there is no warning, it just returns the levels
as.numeric(as.character(year_fct)) # Works...
as.numeric(levels(year_fct))[year_fct]    # The recommended way.
```

# Dates
```{r}
surveys$date <- ymd(paste(surveys$year, surveys$month, surveys$day, sep = "-"))
summary(surveys$date)
missing_dates <- surveys[is.na(surveys$date), c("year", "month", "day")]
```

# Tidyverse

Tidy data:

1. Each variable has its own column
2. Each observation has its own row
3. Each value must have its own cell
4. Each type of observational unit forms a table

`pivot_wider()` takes three principal arguments:

1. the data
2. the `names_from` column variable whose values will become new column names.
3. the `values_from` column variable whose values will fill the new column variables.

Further arguments include `values_fill` which, if set, fills in missing values with the value provided.

```{r}
surveys_gw <- surveys %>%
  filter(!is.na(weight)) %>%
  group_by(plot_id, genus) %>%
  summarize(mean_weight = mean(weight))

surveys_wide <- surveys_gw %>%
  pivot_wider(names_from = genus, values_from = mean_weight)
```

`pivot_longer()` takes four principal arguments:

1. the data
2. the `names_to` column variable we wish to create from column names.
3. the `values_to` column variable we wish to create and fill with values.
4. cols are the name of the columns we use to make this pivot (or to drop).

To recreate `surveys_gw` from `surveys_wide` we would create a names variable called genus and value variable called `mean_weight`.

In pivoting longer, we also need to specify what columns to reshape. If the columns are directly adjacent as they are here, we don’t even need to list the all out: we can just use the : operator!

```{r}
surveys_long <- surveys_wide %>%
  pivot_longer(names_to = "genus", values_to = "mean_weight", cols = -plot_id) # plot_id stays the same
```

Cleaning tip:
```{r}
surveys_complete <- surveys %>%
  filter(!is.na(weight),           # remove missing weight
         !is.na(hindfoot_length),  # remove missing hindfoot_length
         !is.na(sex))                # remove missing sex
```

# Plotting

```{r}
library(hexbin)
```

```{r}
surveys_plot <- ggplot(data = surveys_complete, mapping = aes(x = weight, y = hindfoot_length))

surveys_plot + 
  geom_point()
surveys_plot + 
  geom_hex()
surveys_plot + 
  geom_hex(binwidth = 5) # oogh, that messes with the proportions
surveys_plot + 
  geom_hex(bins = 100) + # Maybe too much but tbh strikes a nice balance between points and hexes
  ggtitle("100 Bins Hexbin Test") +
  theme_bw()
ggplot(data = surveys_complete,
                       mapping = aes(x = weight, y = hindfoot_length, color = as.factor(plot_id))) +
  geom_point() 

# Plot multiple groups on a time series
yearly_counts <- surveys_complete %>%
  count(year, genus) # speedy group_by/summarize for counting
ggplot(data = yearly_counts, aes(x = year, y = n, group = genus, color = genus)) +
    geom_line() # Just adding color = genus would have the same result generally

# Deranged pipe series
surveys_complete %>%
    count(year, genus) %>%
    ggplot(mapping = aes(x = year, y = n, color = genus)) +
    geom_line() +
    labs(title = "Number of each genus over time", x = "Year", y = "Count")
``` 

## Faceting
```{r}
yearly_sex_counts <- surveys_complete %>%
                      count(year, genus, sex)
ggplot(data = yearly_sex_counts,
       mapping = aes(x = year, y = n, color = sex)) +
  geom_line() +
  facet_grid(rows = vars(sex), cols =  vars(genus)) +
  theme_bw() + # This has to go before additional theme() calls or it'll override them
  theme(axis.text.x = element_text(angle = 90),
        strip.text = element_text(face = "italic", size = 5)) # Make genus names (strip is the facet title) italicized
```

## Saving a theme
```{r}
grey_theme <- theme(axis.text.x = element_text(colour="grey20", size = 12,
                                               angle = 90, hjust = 0.5,
                                               vjust = 0.5),
                    axis.text.y = element_text(colour = "grey20", size = 12),
                    text=element_text(size = 16),
                    panel.background = element_rect(fill = "pink"),
                    plot.background = element_rect(fill = "purple"),
                    panel.border = element_rect(fill = NA, color = "yellow", linewidth = 4),
                    panel.grid = element_line(color = "cornflowerblue"))

ggplot(surveys_complete, aes(x = species_id, y = hindfoot_length)) +
    geom_boxplot() +
    grey_theme # This is aesthetically pretty bad, but a useful guide.
```

## Patchwork
This package lets us put several plots in one figure.
[Here are some more examples](https://patchwork.data-imaginist.com/)
```{r}
library(patchwork) 
```

```{r}
plot_weight <- ggplot(data = surveys_complete, aes(x = species_id, y = weight)) +
  geom_boxplot() +
  labs(x = "Species", y = expression(log[10](Weight))) +
  scale_y_log10()

plot_count <- ggplot(data = yearly_counts, aes(x = year, y = n, color = genus)) +
  geom_line() +
  labs(x = "Year", y = "Abundance")

plot_weight / plot_count + plot_layout(heights = c(4, 2)) 
```

```{r}
scatter1 <- ggplot(data = surveys_complete, aes(x = hindfoot_length, y = weight)) +
  geom_point()
scatter2 <- ggplot(data = surveys_complete, aes(x = hindfoot_length, y = weight, color = sex)) +
  geom_point()
histogram3 <- ggplot(data = surveys_complete, aes(x = hindfoot_length)) +
  geom_histogram()

plot_combined <- (scatter1 | scatter2) / histogram3 # patchwork times

plot_combined2 <- plot_combined + plot_annotation(
  title = 'The surprising truth about Surveys',
  subtitle = 'These 3 plots will reveal yet-untold secrets about our beloved data-set',
  caption = 'Disclaimer: None of these plots are insightful'
)

plot_combined2

ggsave("~/Dropbox/Coding/Summer2024/RTutorials/DataCarpentry/Figures/plot_combined.png", plot_combined2, width = 10, dpi = 300)
```

[How to query larger online databases](https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html)
