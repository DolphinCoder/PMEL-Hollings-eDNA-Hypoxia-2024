---
title: "eDNA Exploration (Take 2)"
author: "Eleanor (Ella) Crotty"
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
output:
  pdf_document:
    toc: TRUE
urlcolor: blue
---

```{r Package Imports, message = F, warning = F}
# Warnings and startup messages suppressed
library(tidyverse)
library(patchwork)
library(scales)
library(ggrepel)
library(readxl)
library(here)
```

# Import eDNA data

```{r}
mifishReads <- read.csv(here("OCNMS_eDNA", "Data", "OCNMS_MiFish_Data.csv"))
mifishReads <- mifishReads %>% 
  mutate(Marker = "MiFish")
```

# Import species of interest

```{r}
# SOI_df <- read.csv(here("OCNMS_eDNA", "Data", "OCNMS_SpeciesOfInterest_Clean.csv"))
genera <- c("Pseudo-nitzchia", "Pyrosoma", "Pyrosomella", "Sargassum", "Undaria", "Acrozoanthus", "Isarus", "Zoanthus")
families <- c("Ammodytidae", "Acipenseridae")
```

# Clean

```{r}
# Remove non-TH042 samples
# Remove Chris Paight samples

```

# Functions

```{r}
# Summaries

SOI_fn <- function(df) {
  marker <- df$Marker[1]
  
  s <- df %>% 
    group_by(Species) %>% 
    summarize(Count = n(), MeanPctMatch = mean(pctMatch), Genus = NA, Family = NA) %>% 
    filter(Species %in% SpeciesOfInterest) %>% 
    select(Family, Genus, Species, Count, MeanPctMatch) %>% 
    mutate(Marker = marker)
  
  g <- df %>% 
    group_by(Genus) %>% 
    summarize(Count = n(), MeanPctMatch = mean(pctMatch), Species = NA, Family = NA) %>% 
    filter(Genus %in% genera) %>% 
    select(Family, Genus, Species, Count, MeanPctMatch) %>% 
    mutate(Marker = marker)
  
  f <- df %>% 
    group_by(Family) %>% 
    summarize(Count = n(), MeanPctMatch = mean(pctMatch), Genus = NA, Species = NA) %>% 
    filter(Family %in% families) %>% 
    select(Family, Genus, Species, Count, MeanPctMatch) %>% 
    mutate(Marker = marker)
  
  rbind(s,g,f)
}

MiFish_SOI_id_summary <- SOI_fn(mifishReads)
```

```{r}
# Now to make a df of all the detections (not a summary per species & marker)
SOI_full_fn <- function(df) {
  marker <- df$Marker[1]
  s <- df %>% 
    filter(Species %in% SpeciesOfInterest | Genus %in% genera | Family %in% families) %>% 
    mutate(Marker = marker) %>% 
    select(ESV, Kingdom, Phylum, Class, Order, Family, Genus, Species, Marker)
  s
}

MiFish_SOI_IDs <- SOI_full_fn(mifishReads)
```


